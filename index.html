<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Don&#39;t Starve Checklist</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="container">
      <img class="title-image" src="images/dont_starve_logo.png" alt="Don't Starve" />
      <div class="site-subtitle">Seasonal Checklist</div>
      <section class="sections">
        <div class="panel first-autumn left-column">
          <h2 class="panel-title">First Autumn</h2>
          <div class="panel-subtitle">Day 21 - Start of Winter<br/>Day 30 - Deerclops Appears</div>
          <div class="panel-section">
            <h3 class="panel-title">Find on Map</h3>
            <div class="panel-images"></div>
          </div>
          <div class="panel-section base-building">
            <h3 class="panel-title">Base Building</h3>
            <div class="panel-images"></div>
          </div>

          <div class="panel-section personal-items">
            <h3 class="panel-title">Personal Items</h3>
            <div class="panel-images"></div>
          </div>
        </div>
        
        <div class="panel first-winter left-column">
          <h2 class="panel-title">First Winter</h2>
          <div class="panel-subtitle">Day 30 - Deerclops Appears<br/>Day 36 - Start of Spring<br/>Day 35-37 - Moose/Goose Appears</div>
          <div class="panel-section base-building">
            <h3 class="panel-title">Base Building</h3>
            <div class="panel-images">
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="tent"
                  src="images/tent_build.png"
                  alt="Tent"
                />
              </div>
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="lightning-rod"
                  src="images/lightning_rod_build.png"
                  alt="Lightning Rod"
                />
              </div>
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="think-tank"
                  src="images/think_tank_build.png"
                  alt="Think Tank"
                />
              </div>
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="spider-den"
                  src="images/spider_den.png"
                  alt="Spider Den"
                />
              </div>
            </div>
          </div>
          <div class="panel-section">
            <h3 class="panel-title">Personal Items</h3>
            <div class="panel-images">
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="walking-cane" src="images/walking_cane.png" alt="Walking Cane" />
              </div>
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="tam-o-shanter" src="images/tam_o_shanter.png" alt="Tam o' Shanter" />
              </div>
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="umbrella-winter" src="images/umbrella.png" alt="Umbrella" />
              </div>
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="log-suit-w1" src="images/log_suit.png" alt="Log Suit" />
              </div>
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="log-suit-w2" src="images/log_suit.png" alt="Log Suit" />
              </div>
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="spear-w1" src="images/spear.png" alt="Spear" />
              </div>
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="spear-w2" src="images/spear.png" alt="Spear" />
              </div>
            </div>
          </div>
        </div>
        <div class="panel first-spring left-column">
          <h2 class="panel-title">First Spring</h2>
          <div class="panel-section base-building">
            <h3 class="panel-title">Base Building</h3>
            <div class="panel-images">
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="shadow-manipulator" src="images/shadow_manipulator_build.png" alt="Shadow Manipulator" />
              </div>
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="rabbit-hutch" src="images/rabbit_hutch_build.png" alt="Rabbit Hutch" />
              </div>
            </div>
          </div>
          <div class="panel-section">
            <h3 class="panel-title">Personal Items</h3>
            <div class="panel-images">
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="desert-goggles" src="images/desert_goggles.png" alt="Desert Goggles" />
              </div>
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="lantern" src="images/lantern.png" alt="Lantern" />
              </div>
              <div class="panel-image-wrap">
                <img class="panel-image" data-key="pierogi" src="images/pierogi_build.png" alt="Pierogi" />
              </div>
            </div>
          </div>
        </div>
        <div class="panel first-summer left-column">
          <h2 class="panel-title">First Summer</h2>
          <div class="panel-section base-building">
            <h3 class="panel-title">Base Building</h3>
            <div class="panel-images"></div>
          </div>
          <div class="panel-section">
            <h3 class="panel-title">Personal Items</h3>
            <div class="panel-images"></div>
          </div>
        </div>
        <div class="panel misc left-column">
          <h2 class="panel-title">Misc</h2>
          <div class="panel-section">
            <h3 class="panel-title">Find on Map</h3>
            <div class="panel-images"></div>
          </div>
          <div class="panel-section base-building">
            <h3 class="panel-title">Base Building</h3>
            <div class="panel-images"></div>
          </div>
          <div class="panel-section personal-items">
            <h3 class="panel-title">Personal Items</h3>
            <div class="panel-images"></div>
          </div>
        </div>
        <div class="panel kills right-column">
          <h2 class="panel-title">Kills</h2>
          <div class="panel-section">
            <h3 class="panel-title">Mini Bosses</h3>
            <div class="panel-images">
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="spider-queen"
                  data-name="Spider Queen"
                  data-hp="2500"
                  src="images/spider_queen.png"
                  alt="Spider Queen"
                />
              </div>
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="treeguard"
                  data-name="Treeguard"
                  data-hp="3750"
                  src="images/treeguard.png"
                  alt="Treeguard"
                />
              </div>
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="mactusk"
                  data-name="MacTusk"
                  data-hp="300"
                  src="images/mactusk.png"
                  alt="MacTusk"
                />
              </div>
            </div>
          </div>
          <div class="panel-section">
            <h3 class="panel-title">Seasonal Bosses</h3>
            <div class="panel-images">
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="deerclops"
                  data-name="Deerclops"
                  data-hp="4000"
                  src="images/deerclops.png"
                  alt="Deerclops"
                />
              </div>
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="moose-goose"
                  data-name="Moose/Goose"
                  data-hp="6000"
                  src="images/moose_goose.png"
                  alt="Moose/Goose"
                />
              </div>
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="bearger"
                  data-name="Bearger"
                  data-hp="6000"
                  src="images/bearger.png"
                  alt="Bearger"
                />
              </div>
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="antlion"
                  data-name="Antlion"
                  data-hp="6000"
                  src="images/antlion.png"
                  alt="Antlion"
                />
              </div>
            </div>
          </div>
          <div class="panel-section">
            <h3 class="panel-title">Anytime Bosses</h3>
            <div class="panel-images">
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="lord-of-the-fruit-flies"
                  data-name="Lord of the Fruit Flies"
                  data-hp="1500"
                  src="images/lord_of_the_fruit_flies.png"
                  alt="Lord of the Fruit Flies"
                />
              </div>
              <div class="panel-image-wrap">
                <img
                  class="panel-image"
                  data-key="eye-of-terror"
                  data-name="Eye of Terror"
                  data-hp="5000"
                  data-link="https://dontstarve.fandom.com/wiki/Eye_of_Terror"
                  src="images/eye_of_terror.png"
                  alt="Eye of Terror"
                />
              </div>
            </div>
          </div>
        </div>
        
      </section>
    </main>
    <div class="clear-actions">
      <button id="clearButton" class="clear-button" type="button">Clear</button>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_PREFIX = 'dscheck_dim_';
        const storageKey = (raw) => `${STORAGE_PREFIX}${encodeURIComponent(raw)}`;
        const DND_PREFIX = 'dscheck_dnd_';

        // Apply personal-items layout to all sections named "Personal Items"
        document.querySelectorAll('.panel-section > .panel-title').forEach((titleEl) => {
          if (titleEl.textContent.trim() === 'Personal Items') {
            const section = titleEl.parentElement;
            if (section) section.classList.add('personal-items');
          }
        });

        // Render items from CSV into seasonal panels
        const sectionKeyFor = (season, section) => `${season}::${section}`;
        const findPanelSection = (season, section) => {
          const panel = document.querySelector(`.panel h2.panel-title:nth-of-type(1)`)?.parentElement;
          const panelsByTitle = Array.from(document.querySelectorAll('.panel')).reduce((acc, p) => {
            const title = p.querySelector('h2.panel-title')?.textContent?.trim();
            if (title) acc[title] = p;
            return acc;
          }, {});
          const panelEl = panelsByTitle[season];
          if (!panelEl) return null;
          const sectionEls = Array.from(panelEl.querySelectorAll('.panel-section'));
          for (const s of sectionEls) {
            const t = s.querySelector('.panel-title')?.textContent?.trim();
            if (t === section) return s.querySelector('.panel-images');
          }
          return null;
        };

        const setupDragDrop = () => {
          // Enable drag & drop between seasonal sections
          const seasonalPanels = ['First Autumn','First Winter','First Spring','First Summer','Misc'];
          const isSeasonalContainer = (el) => {
            const panel = el.closest('.panel');
            const title = panel?.querySelector('h2.panel-title')?.textContent?.trim();
            return seasonalPanels.includes(title);
          };
          const allDropzones = Array.from(document.querySelectorAll('.panel-section .panel-images'))
            .filter((zone) => isSeasonalContainer(zone));

          let draggedWrap = null;
          document.querySelectorAll('.panel-image-wrap').forEach((wrap) => {
            const img = wrap.querySelector('.panel-image');
            if (!img) return;
            // Disable drag for Kills panel items
            const killsPanel = wrap.closest('.panel.kills');
            if (killsPanel) return;
            // Seasonal only
            if (!isSeasonalContainer(wrap)) return;
            // Ensure wrapper and image are draggable
            wrap.draggable = true;
            img.setAttribute('draggable', 'true');
            const onStart = (e) => {
              draggedWrap = wrap;
              wrap.classList.add('is-dragging');
              if (e.dataTransfer) {
                e.dataTransfer.setData('text/plain', img.getAttribute('data-key') || '');
                e.dataTransfer.effectAllowed = 'move';
                try { e.dataTransfer.setDragImage(img, 10, 10); } catch (_) {}
              }
            };
            wrap.addEventListener('dragstart', onStart);
            img.addEventListener('dragstart', onStart);
            wrap.addEventListener('dragend', () => {
              wrap.classList.remove('is-dragging');
              draggedWrap = null;
            });
          });

          const getDragAfterElement = (container, y) => {
            const elements = [...container.querySelectorAll('.panel-image-wrap:not(.is-dragging)')];
            return elements.reduce((closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) {
                return { offset, element: child };
              } else {
                return closest;
              }
            }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
          };

          allDropzones.forEach((zone) => {
            const onOver = (e) => {
              e.preventDefault();
              zone.classList.add('dropzone-hover');
              if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
              if (!draggedWrap) return;
              const afterElement = getDragAfterElement(zone, e.clientY);
              if (afterElement == null) {
                zone.appendChild(draggedWrap);
              } else {
                zone.insertBefore(draggedWrap, afterElement);
              }
            };
            zone.addEventListener('dragover', onOver);
            zone.addEventListener('dragenter', onOver);
            zone.addEventListener('dragleave', () => zone.classList.remove('dropzone-hover'));
            // Allow dropping when hovering over children too
            zone.querySelectorAll('.panel-image-wrap').forEach((child) => {
              child.addEventListener('dragover', onOver);
              child.addEventListener('dragenter', onOver);
            });
            zone.addEventListener('drop', (e) => {
              e.preventDefault();
              zone.classList.remove('dropzone-hover');
              if (!draggedWrap) return;
              const img = draggedWrap.querySelector('.panel-image');
              const key = img?.getAttribute('data-key') || '';
              // Final position already placed during dragover via insertBefore/append
              // Do not persist against remote CSV; CSV is authoritative on reload
            });
          });
        };

        const CSV_URL = 'https://raw.githubusercontent.com/elliemary/dstchecklist/main/objects.csv';
        fetch(`${CSV_URL}?t=${Date.now()}`, { cache: 'no-cache' })
          .then((r) => {
            if (!r.ok) throw new Error('Failed to load remote CSV');
            return r.text();
          })
          .then((csvText) => {
            const lines = csvText.split(/\r?\n/).filter(Boolean);
            const header = lines.shift();
            const rows = lines.map((l) => {
              const parts = l.split(',');
              const name = parts[0];
              const image = parts[1];
              const season = parts[2];
              const section = parts[3];
              return { name, image, season, section };
            });

            // Clear containers
            ['First Autumn','First Winter','First Spring','First Summer','Misc'].forEach((season) => {
              ['Find on Map','Base Building','Personal Items'].forEach((section) => {
                const target = findPanelSection(season, section);
                if (target) target.innerHTML = '';
              });
            });

            // Populate
            rows.forEach(({ name, image, season, section }) => {
              const target = findPanelSection(season, section);
              if (!target) return;
              const wrap = document.createElement('div');
              wrap.className = 'panel-image-wrap';
              const img = document.createElement('img');
              img.className = 'panel-image';
              img.alt = name;
              img.src = image;
              img.setAttribute('data-key', `${season}-${section}-${name}`.toLowerCase().replace(/[^a-z0-9]+/g, '-'));
              // Enable drag for seasonal panels only
              wrap.draggable = true;
              img.classList.add('draggable-image');
              wrap.appendChild(img);
              target.appendChild(wrap);
            });

            // Reapply interactions and personal-items class after render
            document.querySelectorAll('.panel-section > .panel-title').forEach((titleEl) => {
              if (titleEl.textContent.trim() === 'Personal Items') {
                titleEl.parentElement?.classList.add('personal-items');
              }
            });

            // Rebind click toggle persistence
            document.querySelectorAll('.panel-image').forEach((imageElement) => {
              const wrapper = imageElement.closest('.panel-image-wrap');
              const primaryId = imageElement.getAttribute('data-key') || imageElement.getAttribute('src');
              const legacyId = imageElement.getAttribute('data-legacy-src');
              const saved = localStorage.getItem(`${STORAGE_PREFIX}${encodeURIComponent(primaryId)}`);
              if (saved === '1') {
                imageElement.classList.add('is-dimmed');
                if (wrapper) wrapper.classList.add('is-dimmed');
              }
              imageElement.addEventListener('click', () => {
                imageElement.classList.toggle('is-dimmed');
                if (wrapper) wrapper.classList.toggle('is-dimmed');
                const isDimmed = imageElement.classList.contains('is-dimmed');
                localStorage.setItem(`${STORAGE_PREFIX}${encodeURIComponent(primaryId)}`, isDimmed ? '1' : '0');
              });
            });
            setupDragDrop();

            // Skip restoring drag locations; CSV controls placement on reload

          })
          .catch(() => { setupDragDrop(); });

        // Auto-generate captions for boss panels using data attributes
        document.querySelectorAll('.panel.kills .panel-image-wrap, .panel.seasonal-bosses .panel-image-wrap, .panel.anytime-bosses .panel-image-wrap').forEach((wrapElement) => {
          const imgElement = wrapElement.querySelector('.panel-image');
          if (!imgElement) return;
          const name = imgElement.getAttribute('data-name') || imgElement.alt || '';
          const hp = imgElement.getAttribute('data-hp');
          const link = imgElement.getAttribute('data-link');
          const nameHtml = link ? `<a href="${link}" target="_blank" rel="noopener noreferrer">${name}</a>` : name;
          const captionHtml = hp ? `${nameHtml}<br/>❤️ ${hp}` : nameHtml;
          let caption = wrapElement.querySelector('.panel-caption');
          if (!caption) {
            caption = document.createElement('div');
            caption.className = 'panel-caption';
            wrapElement.appendChild(caption);
          }
          caption.innerHTML = captionHtml;
        });

        document.querySelectorAll('.panel-image').forEach((imageElement) => {
          const wrapper = imageElement.closest('.panel-image-wrap');
          const primaryId = imageElement.getAttribute('data-key') || imageElement.getAttribute('src');
          const legacyId = imageElement.getAttribute('data-legacy-src');

          // Restore, with migration from legacy URL-based key if present
          let saved = null;
          try {
            saved = localStorage.getItem(storageKey(primaryId));
            if (saved === null && legacyId) {
              const legacySaved = localStorage.getItem(storageKey(legacyId));
              if (legacySaved !== null) {
                saved = legacySaved;
                localStorage.setItem(storageKey(primaryId), saved);
                localStorage.removeItem(storageKey(legacyId));
              }
            }
          } catch (_) {}

          if (saved === '1') {
            imageElement.classList.add('is-dimmed');
            if (wrapper) wrapper.classList.add('is-dimmed');
          }

          // Toggle and persist on click
          imageElement.addEventListener('click', () => {
            imageElement.classList.toggle('is-dimmed');
            if (wrapper) wrapper.classList.toggle('is-dimmed');
            const isDimmed = imageElement.classList.contains('is-dimmed');
            try {
              localStorage.setItem(storageKey(primaryId), isDimmed ? '1' : '0');
            } catch (_) {}
          });
        });

        // Clear button: reset all dimmed states and remove stored values
        const clearBtn = document.getElementById('clearButton');
        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            document.querySelectorAll('.panel-image').forEach((img) => {
              img.classList.remove('is-dimmed');
              const wrap = img.closest('.panel-image-wrap');
              if (wrap) wrap.classList.remove('is-dimmed');
              const id = img.getAttribute('data-key') || img.getAttribute('src');
              try { localStorage.removeItem(storageKey(id)); } catch (_) {}
            });
          });

          // Match button width to a Crock Pot image if present
          const sizeButtonToCrockPot = () => {
            const crock = document.querySelector('.panel-image[data-key="crock-pot-1"], .panel-image[alt="Crock Pot"]');
            if (crock && clearBtn) {
              const width = crock.clientWidth;
              if (width > 0) {
                clearBtn.style.width = width + 'px';
              }
            }
          };
          sizeButtonToCrockPot();
          window.addEventListener('resize', sizeButtonToCrockPot);
        }
      });
    </script>
  </body>
</html>
